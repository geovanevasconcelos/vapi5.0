<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vapi AI Assistant</title>
    <!-- Include the Vapi Web SDK -->
    <script src="https://cdn.jsdelivr.net/gh/VapiAI/html-script-tag@latest/dist/assets/index.js"></script>
</head>
<body>
    <script>
        // Initialize Vapi instance
        let vapiInstance = null;

        // Utility function to get query parameters
        function getQueryParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        // Utility function to decode Base64 strings
        function base64Decode(str) {
            try {
                return atob(str); // Decode the Base64 string
            } catch (e) {
                console.error("Error decoding Base64 string:", e);
                return str; // Return original string if decoding fails
            }
        }

        // Retrieve and decode parameters from the query string
        const encodedApiKey = getQueryParam('apiKey');
        const apiKey = base64Decode(encodedApiKey) || '<your_public_api_key>';
        const assistantId = getQueryParam('assistant') || '<assistant_id>';
        const title = getQueryParam('title') || 'Have a quick question?';
        const subtitle = getQueryParam('subtitle') || 'Talk with our AI assistant';

        // Define the configuration for the assistant
        const assistantConfig = {
            transcriber: {
                provider: "deepgram",
                model: "nova-2",
                language: "en-US",
            },
            model: {
                provider: "openai",
                model: "gpt-3.5-turbo",
                messages: [
                    {
                        role: "system",
                        content: "You are a helpful assistant.",
                    },
                ],
            },
            voice: {
                provider: "playht",
                voiceId: "jennifer",
            },
            name: "My Inline Assistant",
        };

        // Initialize the assistant when the SDK is loaded
        window.addEventListener('load', function() {
            try {
                // Initialize Vapi SDK
                vapiInstance = window.vapiSDK.run({
                    apiKey: apiKey, // Use the decoded API key
                    assistant: assistantId || assistantConfig, // Either use assistantId or inline config
                });

                // Add listeners for assistant events (e.g., speech-start, call-end, etc.)
                vapiInstance.on('speech-start', () => {
                    console.log("Assistant has started speaking.");
                });

                vapiInstance.on('speech-end', () => {
                    console.log("Assistant has stopped speaking.");
                });

                vapiInstance.on('call-start', () => {
                    console.log("Call has started.");
                });

                vapiInstance.on('call-end', () => {
                    console.log("Call has ended.");
                });

                vapiInstance.on('error', (e) => {
                    console.error("An error occurred with the assistant:", e);
                });

            } catch (error) {
                console.error("Error initializing Vapi instance:", error);
            }
        });

        // Listen for messages from the parent (Bubble app) and handle actions like sending messages
        window.addEventListener('message', function(event) {
            const parentOrigin = getQueryParam('parentOrigin') || window.location.origin;
            
            if (event.origin !== parentOrigin) {
                console.warn("Message from unknown origin:", event.origin);
                return;
            }

            const data = event.data;

            if (data && data.type === 'add-message') {
                // Send the background message to the assistant using the .send() method
                if (vapiInstance) {
                    vapiInstance.send({
                        type: 'add-message',
                        message: {
                            role: data.message.role || 'system', // Use provided role or default to 'system'
                            content: data.message.content || 'No message provided.', // Use provided content
                        }
                    });
                    console.log("Message sent to assistant:", data.message.content);
                } else {
                    console.error("Vapi instance not initialized.");
                }
            }
        });

    </script>
</body>
</html>
